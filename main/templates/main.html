{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Kick n' Cart</title>
{% endblock meta %}

{% block content %}
<div class="bg-[#EBDDC5] w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- HEADER -->
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-[#2E4365] mb-2">Kick n' Cart</h1>
        <p class="text-gray-600">Find the best football gear and accessories</p>
      </div>
      <div class="mt-4 sm:mt-0">
        <button onclick="openAddModal()" 
          class="bg-[#E59D2C] text-white px-5 py-2 rounded-md hover:bg-[#C97C1F] transition">
          + Add Product
        </button>
      </div>
    </div>

    <!-- FILTER -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a href="?"
           class="{% if request.GET.filter == 'all' or not request.GET.filter %} bg-[#2E4365] text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium hover:bg-[#2E4365] hover:text-white transition">
          All Products
        </a>
        <a href="?filter=my"
           class="{% if request.GET.filter == 'my' %} bg-[#2E4365] text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium hover:bg-[#2E4365] hover:text-white transition">
          My Products
        </a>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-600">
          <p class="font-medium">Welcome, {{ user.username }}!</p>
          <p>Last login: {{ last_login }}</p>
        </div>
      {% endif %}
    </div>

    <!-- PRODUCT GRID / EMPTY STATE -->
    <div id="product-section">
      {% if not products %}
        <div id="no-product" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
          <div class="w-32 h-32 mx-auto mb-4">
            <img src="{% static 'image/no-product.png' %}" alt="No product" class="w-full h-full object-contain">
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
          <p class="text-gray-500 mb-6">Be the first to add a product to the shop.</p>
          <button onclick="openAddModal()" 
            class="inline-flex items-center px-4 py-2 bg-[#E59D2C] text-white rounded-md hover:bg-[#C97C1F] transition">
            Add Product
          </button>
        </div>
      {% else %}
        <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for product in products %}
            {% include 'card_product.html' with product=product %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =========================
     MODAL ADD PRODUCT
========================= -->
<div id="addProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-lg relative">
    <button onclick="closeAddModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✕</button>
    <h2 class="text-2xl font-semibold text-[#2E4365] mb-4">Add New Product</h2>

    <form id="addProductForm" onsubmit="submitAddProduct(event)">
      {% csrf_token %}
      <div class="space-y-3">
        <input type="text" name="name" placeholder="Product Name" required class="w-full border rounded-md px-3 py-2">
        <input type="number" name="price" placeholder="Price (Rp)" required class="w-full border rounded-md px-3 py-2">
        <textarea name="description" placeholder="Description" required class="w-full border rounded-md px-3 py-2"></textarea>
        <input type="url" name="thumbnail" placeholder="Image URL" class="w-full border rounded-md px-3 py-2">
        <select name="category" class="w-full border rounded-md px-3 py-2">
          <option value="">Select Category</option>
          <option value="sepatu">Sepatu</option>
          <option value="jersey">Jersey</option>
          <option value="bola">Bola</option>
          <option value="aksesoris">Aksesoris</option>
        </select>
        <input type="text" name="brand" placeholder="Brand" class="w-full border rounded-md px-3 py-2">
        <input type="number" name="stock" placeholder="Stock" class="w-full border rounded-md px-3 py-2">
        <label class="flex items-center space-x-2">
          <input type="checkbox" name="is_featured" value="true" class="rounded border-gray-300">
          <span>Mark as Featured</span>
        </label>
      </div>
      <div class="mt-5 flex justify-end space-x-3">
        <button type="button" onclick="closeAddModal()" class="px-4 py-2 border rounded-md">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-[#E59D2C] text-white rounded-md hover:bg-[#C97C1F] transition">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- =========================
     MODAL EDIT PRODUCT
========================= -->
<div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-lg relative">
    <button onclick="closeEditModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✕</button>
    <h2 class="text-2xl font-semibold text-[#2E4365] mb-4">Edit Product</h2>

    <form id="editProductForm" onsubmit="submitEditProduct(event)">
      {% csrf_token %}
      <input type="hidden" id="edit-id" name="id">

      <div class="space-y-3">
        <input type="text" id="edit-name" name="name" placeholder="Product Name" required class="w-full border rounded-md px-3 py-2">
        <input type="number" id="edit-price" name="price" placeholder="Price" required class="w-full border rounded-md px-3 py-2">
        <textarea id="edit-description" name="description" placeholder="Description" required class="w-full border rounded-md px-3 py-2"></textarea>
        <input type="url" id="edit-thumbnail" name="thumbnail" placeholder="Image URL" class="w-full border rounded-md px-3 py-2">
        <select id="edit-category" name="category" class="w-full border rounded-md px-3 py-2">
          <option value="">Select Category</option>
          <option value="sepatu">Sepatu</option>
          <option value="jersey">Jersey</option>
          <option value="bola">Bola</option>
          <option value="aksesoris">Aksesoris</option>
        </select>
        <input type="text" id="edit-brand" name="brand" placeholder="Brand" class="w-full border rounded-md px-3 py-2">
        <input type="number" id="edit-stock" name="stock" placeholder="Stock" class="w-full border rounded-md px-3 py-2">
        <label class="flex items-center space-x-2">
          <input type="checkbox" id="edit-is-featured" name="is_featured" class="rounded border-gray-300">
          <span>Mark as Featured</span>
        </label>
      </div>

      <div class="mt-5 flex justify-end space-x-3">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 border rounded-md">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-[#2E4365] text-white rounded-md hover:bg-[#1f314a] transition">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- =========================
     SCRIPT SECTION
========================= -->
<script>
function getCSRFToken() {
  const name = 'csrftoken';
  const cookie = document.cookie.split('; ').find(row => row.startsWith(name + '='));
  return cookie ? decodeURIComponent(cookie.split('=')[1]) : '';
}

// === OPEN / CLOSE MODALS ===
function openAddModal() { document.getElementById('addProductModal').classList.remove('hidden'); }
function closeAddModal() { document.getElementById('addProductModal').classList.add('hidden'); }
function openEditModalFromButton(btn) {
  const article = btn.closest('[data-product-id]');
  document.getElementById('edit-id').value = article.dataset.productId;
  document.getElementById('edit-name').value = article.dataset.name;
  document.getElementById('edit-price').value = article.dataset.price;
  document.getElementById('edit-description').value = article.dataset.description;
  document.getElementById('edit-thumbnail').value = article.dataset.thumbnail;
  document.getElementById('edit-category').value = article.dataset.category;
  document.getElementById('edit-brand').value = article.dataset.brand;
  document.getElementById('edit-stock').value = article.dataset.stock;
  document.getElementById('edit-is-featured').checked = article.dataset.isFeatured === "true";
  document.getElementById('editProductModal').classList.remove('hidden');
}
function closeEditModal() { document.getElementById('editProductModal').classList.add('hidden'); }

// === ADD PRODUCT ===
async function submitAddProduct(e) {
  e.preventDefault();
  const form = document.getElementById('addProductForm');
  const formData = new FormData(form);
  try {
    const res = await fetch("{% url 'main:add_product_entry_ajax' %}", {
      method: "POST",
      headers: {"X-Requested-With": "XMLHttpRequest"},
      body: formData
    });
    const data = await res.json();
    if (!res.ok || data.status === "error") throw new Error();
    closeAddModal();
    showToast("Success", "Product added successfully!", "success");
    location.reload();
  } catch {
    showToast("Error", "Failed to add product.", "error");
  }
}

// === EDIT PRODUCT ===
async function submitEditProduct(e) {
  e.preventDefault();
  const id = document.getElementById("edit-id").value;
  const form = document.getElementById("editProductForm");
  const formData = new FormData(form);

  try {
    const res = await fetch(`/product/${id}/edit/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest"
      },
      credentials: "same-origin",
      body: formData
    });

    const data = await res.json();
    if (!res.ok || data.status !== "success") throw new Error(data.message || "Failed");
    closeEditModal();
    showToast("Updated", "Product updated successfully!", "success");
    setTimeout(() => location.reload(), 600);
  } catch (err) {
    showToast("Error", err.message || "Failed to update product.", "error");
  }
}

// === DELETE PRODUCT ===
async function deleteProduct(id, btn) {
  if (!confirm("Are you sure you want to delete this product?")) return;
  try {
    const res = await fetch(`/product/${id}/delete/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest",
        "Accept": "application/json"
      },
      credentials: "same-origin"
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed to delete");
    btn.closest("article").remove();
    showToast("Deleted", "Product deleted successfully!", "success");
  } catch (err) {
    showToast("Error", err.message || "Failed to delete product.", "error");
  }
}
</script>

{% endblock content %}
