{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Kick n' Cart</title>
{% endblock meta %}

{% block content %}
<div class="bg-[#EBDDC5] w-full pt-16 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- HEADER -->
    <div class="mb-8 flex flex-col sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-3xl font-bold text-[#2E4365] mb-2">Kick n' Cart</h1>
        <p class="text-gray-600">Find the best football gear and accessories</p>
      </div>
      <div class="mt-4 sm:mt-0">
        <button onclick="openAddModal()" 
          class="bg-[#E59D2C] text-white px-5 py-2 rounded-md hover:bg-[#C97C1F] transition">
          + Add Product
        </button>
      </div>
    </div>

    <!-- FILTER -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a href="?"
           class="{% if request.GET.filter == 'all' or not request.GET.filter %} bg-[#2E4365] text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium hover:bg-[#2E4365] hover:text-white transition">
          All Products
        </a>
        <a href="?filter=my"
           class="{% if request.GET.filter == 'my' %} bg-[#2E4365] text-white{% else %}bg-white text-gray-700 border border-gray-300{% endif %} px-4 py-2 rounded-md font-medium hover:bg-[#2E4365] hover:text-white transition">
          My Products
        </a>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm text-gray-600">
          <p class="font-medium">Welcome, {{ user.username }}!</p>
          <p>Last login: {{ last_login }}</p>
        </div>
      {% endif %}
    </div>

    <!-- PRODUCT GRID / EMPTY STATE -->
    <div id="product-section">
      {% if not products %}
        <div id="no-product" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
          <div class="w-32 h-32 mx-auto mb-4">
            <img src="{% static 'image/no-product.png' %}" alt="No product" class="w-full h-full object-contain">
          </div>
          <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
          <p class="text-gray-500 mb-6">Be the first to add a product to the shop.</p>
          <button onclick="openAddModal()" 
            class="inline-flex items-center px-4 py-2 bg-[#E59D2C] text-white rounded-md hover:bg-[#C97C1F] transition">
            Add Product
          </button>
        </div>
      {% else %}
        <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for product in products %}
            {% include 'card_product.html' with product=product %}
          {% endfor %}
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- =========================
     MODAL ADD PRODUCT
========================= -->
<div id="addProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-lg relative">
    <button onclick="closeAddModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✕</button>
    <h2 class="text-2xl font-semibold text-[#2E4365] mb-4">Add New Product</h2>

    <form id="addProductForm" onsubmit="submitAddProduct(event)">
      {% csrf_token %}
      <div class="space-y-3">
        <input type="text" name="name" placeholder="Product Name" required class="w-full border rounded-md px-3 py-2">
        <input type="number" name="price" placeholder="Price (Rp)" required class="w-full border rounded-md px-3 py-2">
        <textarea name="description" placeholder="Description" required class="w-full border rounded-md px-3 py-2"></textarea>
        <input type="url" name="thumbnail" placeholder="Image URL" class="w-full border rounded-md px-3 py-2">
        <select name="category" class="w-full border rounded-md px-3 py-2">
          <option value="">Select Category</option>
          <option value="sepatu">Sepatu</option>
          <option value="jersey">Jersey</option>
          <option value="bola">Bola</option>
          <option value="aksesoris">Aksesoris</option>
        </select>
        <input type="text" name="brand" placeholder="Brand" class="w-full border rounded-md px-3 py-2">
        <input type="number" name="stock" placeholder="Stock" class="w-full border rounded-md px-3 py-2">
        <label class="flex items-center space-x-2">
          <input type="checkbox" name="is_featured" value="true" class="rounded border-gray-300">
          <span>Mark as Featured</span>
        </label>
      </div>
      <div class="mt-5 flex justify-end space-x-3">
        <button type="button" onclick="closeAddModal()" class="px-4 py-2 border rounded-md">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-[#E59D2C] text-white rounded-md hover:bg-[#C97C1F] transition">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- =========================
     MODAL EDIT PRODUCT
========================= -->
<div id="editProductModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-lg relative">
    <button onclick="closeEditModal()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-700">✕</button>
    <h2 class="text-2xl font-semibold text-[#2E4365] mb-4">Edit Product</h2>

    <form id="editProductForm" onsubmit="submitEditProduct(event)">
      {% csrf_token %}
      <input type="hidden" id="edit-id" name="id">

      <div class="space-y-3">
        <input type="text" id="edit-name" name="name" placeholder="Product Name" required class="w-full border rounded-md px-3 py-2">
        <input type="number" id="edit-price" name="price" placeholder="Price" required class="w-full border rounded-md px-3 py-2">
        <textarea id="edit-description" name="description" placeholder="Description" required class="w-full border rounded-md px-3 py-2"></textarea>
        <input type="url" id="edit-thumbnail" name="thumbnail" placeholder="Image URL" class="w-full border rounded-md px-3 py-2">
        <select id="edit-category" name="category" class="w-full border rounded-md px-3 py-2">
          <option value="">Select Category</option>
          <option value="sepatu">Sepatu</option>
          <option value="jersey">Jersey</option>
          <option value="bola">Bola</option>
          <option value="aksesoris">Aksesoris</option>
        </select>
        <input type="text" id="edit-brand" name="brand" placeholder="Brand" class="w-full border rounded-md px-3 py-2">
        <input type="number" id="edit-stock" name="stock" placeholder="Stock" class="w-full border rounded-md px-3 py-2">
        <label class="flex items-center space-x-2">
          <input type="checkbox" id="edit-is-featured" name="is_featured" class="rounded border-gray-300">
          <span>Mark as Featured</span>
        </label>
      </div>

      <div class="mt-5 flex justify-end space-x-3">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 border rounded-md">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-[#2E4365] text-white rounded-md hover:bg-[#1f314a] transition">Update</button>
      </div>
    </form>
  </div>
</div>

<!-- =========================
     SCRIPT SECTION
========================= -->
<script>
function getCSRFToken() {
  const name = 'csrftoken';
  const cookie = document.cookie.split('; ').find(row => row.startsWith(name + '='));
  return cookie ? decodeURIComponent(cookie.split('=')[1]) : '';
}

// === OPEN / CLOSE MODALS ===
function openAddModal() { document.getElementById('addProductModal').classList.remove('hidden'); }
function closeAddModal() { document.getElementById('addProductModal').classList.add('hidden'); }
function openEditModalFromButton(btn) {
  const article = btn.closest('[data-product-id]');
  document.getElementById('edit-id').value = article.dataset.productId;
  document.getElementById('edit-name').value = article.dataset.name;
  document.getElementById('edit-price').value = article.dataset.price;
  document.getElementById('edit-description').value = article.dataset.description;
  document.getElementById('edit-thumbnail').value = article.dataset.thumbnail;
  document.getElementById('edit-category').value = article.dataset.category;
  document.getElementById('edit-brand').value = article.dataset.brand;
  document.getElementById('edit-stock').value = article.dataset.stock;
  document.getElementById('edit-is-featured').checked = article.dataset.isFeatured === "true";
  document.getElementById('editProductModal').classList.remove('hidden');
}
function closeEditModal() { document.getElementById('editProductModal').classList.add('hidden'); }

// === ADD PRODUCT ===
async function submitAddProduct(e) {
  e.preventDefault();
  const form = document.getElementById('addProductForm');
  const formData = new FormData(form);
  try {
    const res = await fetch(`/create-product-ajax/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest"
      },
      credentials: "same-origin", 
      body: formData
    });

    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch (err) {
      console.error("Non-JSON response from create-product-ajax:", text);
      throw new Error("Server error");
    }

    if (!res.ok || data.status === "error") throw new Error(data.message || "Failed");

    closeAddModal();
    showToast("Success", "Product added successfully!", "success");

    if (typeof addProductCard === "function") {
      addProductCard(data);
    } else {
      // fallback
      setTimeout(() => location.reload(), 300);
    }
  } catch (err) {
    console.error("submitAddProduct error:", err);
    showToast("Error", "Failed to add product.", "error");
  }
}

// === EDIT PRODUCT ===
async function submitEditProduct(e) {
  e.preventDefault();
  const id = document.getElementById("edit-id").value;
  const form = document.getElementById("editProductForm");
  const formData = new FormData(form);

  formData.set("is_featured", document.getElementById("edit-is-featured").checked ? "true" : "false");

  try {
    const res = await fetch(`/product/${id}/edit/ajax/`, {  // ✅ FIXED
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest",
      },
      credentials: "same-origin",
      body: formData,
    });

    const data = await res.json();
    if (!res.ok || data.status !== "success") throw new Error(data.message || "Failed");
    closeEditModal();
    showToast("Updated", "Product updated successfully!", "success");
    setTimeout(() => location.reload(), 600);
  } catch (err) {
    showToast("Error", err.message || "Failed to update product.", "error");
  }
}

// === DELETE PRODUCT ===
async function deleteProduct(id, btn) {
  if (!confirm("Are you sure you want to delete this product?")) return;
  try {
    const res = await fetch(`/product/${id}/delete/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCSRFToken(),
        "X-Requested-With": "XMLHttpRequest",
        "Accept": "application/json"
      },
      credentials: "same-origin"
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Failed to delete");
    btn.closest("article").remove();
    showToast("Deleted", "Product deleted successfully!", "success");
  } catch (err) {
    showToast("Error", err.message || "Failed to delete product.", "error");
  }
}

// === VIEW IMAGE HANDLER ===
document.addEventListener("click", function (e) {
  if (e.target.matches(".view-image-btn")) {
    const article = e.target.closest("[data-product-id]");
    const imageUrl = article ? article.dataset.thumbnail : null;
    if (imageUrl) {
      // Buat modal untuk preview gambar
      const modal = document.createElement("div");
      modal.className =
        "fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 animate-fadeIn";
      modal.innerHTML = `
        <div class="relative bg-white rounded-lg overflow-hidden shadow-lg max-w-2xl">
          <button class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl font-bold">&times;</button>
          <img src="${imageUrl}" alt="Product Image" class="max-h-[80vh] object-contain">
        </div>
      `;
      document.body.appendChild(modal);
      // Tutup modal saat klik di luar / tombol close
      modal.addEventListener("click", (ev) => {
        if (ev.target === modal || ev.target.matches("button")) modal.remove();
      });
    } else {
      showToast("Error", "No image found for this product.", "error");
    }
  }
});

function addProductCard(data) {
  const grid = document.getElementById("product-grid");
  // Jika belum ada grid (mis: sebelumnya kosong), tambahkan container
  if (!grid) {
    const section = document.getElementById("product-section");
    const container = document.createElement("div");
    container.id = "product-grid";
    container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
    section.innerHTML = ""; // hapus empty state
    section.appendChild(container);
  }
  const targetGrid = document.getElementById("product-grid");

  const article = document.createElement("article");
  article.className = "bg-white rounded-xl border border-gray-200 hover:shadow-2xl hover:border-[#E59D2C] transition overflow-hidden";
  article.setAttribute("data-product-id", data.id);
  article.setAttribute("data-name", (data.name||"").replace(/"/g,'&quot;'));
  article.setAttribute("data-price", data.price || 0);
  article.setAttribute("data-description", (data.description||"").replace(/"/g,'&quot;'));
  article.setAttribute("data-thumbnail", data.thumbnail || "");
  article.setAttribute("data-category", data.category || "");
  article.setAttribute("data-brand", data.brand || "");
  article.setAttribute("data-stock", data.stock || 0);
  article.setAttribute("data-is-featured", data.is_featured ? "true" : "false");

  // Build inner html 
  article.innerHTML = `
    <div class="aspect-[16/9] relative overflow-hidden group">
      <img src="${data.thumbnail || '/static/image/no-product.png'}"
           alt="${(data.name||'Product').replace(/"/g,'&quot;')}"
           class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105"
           onerror='this.onerror=null;this.src="{% static "image/no-product.png" %}";'>
      <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center z-20 cursor-pointer"
           onclick="openModal('${(data.thumbnail||'').replace(/'/g,'\\\'')}', '${data.id}')">
        <span class="text-white text-sm font-medium select-none">View Image</span>
      </div>
    </div>

    <div class="p-6">
      <div class="flex items-center text-xs text-gray-500 mb-2">
        <time>${new Date().toLocaleDateString()}</time>
      </div>

      <h3 class="text-xl font-bold text-[#2E4365] mb-2 leading-snug">
        <a href="/product/${data.id}/" class="hover:text-[#E59D2C] transition-colors">${data.name}</a>
      </h3>

      <p class="text-lg font-semibold text-[#228B22] mb-3">Rp ${data.price}</p>
      <p class="text-gray-600 text-sm leading-relaxed line-clamp-2 mb-4">${(data.description||'').substring(0,120)}</p>

      <div class="flex items-center justify-between pt-4 border-t border-gray-200">
        <a href="/product/${data.id}/" class="px-4 py-2 bg-[#E59D2C] text-white rounded-md hover:bg-[#C97C1F] text-sm transition">View</a>
        <div class="flex space-x-2">
          <button onclick="openEditModalFromButton(this)" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm transition">Edit</button>
          <button onclick="deleteProduct('${data.id}', this)" class="px-3 py-1.5 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm transition">Delete</button>
        </div>
      </div>
    </div>
  `;

  // prepend supaya muncul paling atas
  targetGrid.prepend(article);
}
</script>

{% endblock content %}
